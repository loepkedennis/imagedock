image: docker:latest

variables:
  DOCKER_DRIVER: overlay

services:
- docker:dind

before_script:
- docker info
- apk update
- apk upgrade
- apk add python python-dev py-pip build-base
- pip install docker-compose
- docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com

stages:
  - build
  - deploy
  - test


#build:
#  stage: build
#  script:
#  - docker-compose -f docker-compose.yml build
#  - docker push imagedock

#deploy: 
#  stage: deploy
#  script:
#  - docker-compose -f docker-compose.yml up -d

test:
  stage: test
  script:
#  - set -e
  - docker-compose -f docker-compose.yml build --no-cache
  - docker-compose -f docker-compose.yml up -d
  - docker-compose -f docker-compose.yml run --no-deps --rm -e ENV=UNIT imagedock
  - ERR=$?
  - /bin/sh if [ 0 -eq 0 ]; then echo "test" "123" fi 
#  - if [ $ERR -eq 0 ]; then IP=$(sudo docker inspect -f {{.NetworkSettings.IPAddress}} citesting_imagedock_1) CODE=$(curl -sL -w "%{http_code}" $IP:5000/monster/bla \
 # dev/null) || true if [ $CODE -ne 200 ]; then echo "Site return " fi fi
 #- echo $ERR
  
