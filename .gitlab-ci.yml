image: docker:latest

variables:
  DOCKER_DRIVER: overlay

services:
- docker:dind

before_script:
- docker info
- apk update
- apk upgrade
- apk add python python-dev py-pip build-base
- pip install docker-compose

build:
  stage: build
  script:
  - docker-compose -f docker-compose.yml build

deploy: 
  stage: deploy
  script:
  - docker-compose -f docker-compose.yml up -d

test:
  stage: test
  script:
  - docker-compose -f docker-compose.yml run --no-deps --rm -e ENV=UNIT imagedock ERR=$? 
  #Run system test if unit test passed 
  if[$ERR-eq0];then
	IP=$(sudo docker inspect -f {{.NetworkSettings.IPAddress}} \
	imagedock_1)
	CODE=$(curl -sL -w "%{http_code}" $IP:9090/monster/bla \
	-o /dev/null) || true
	if [ $CODE -ne 200 ]; then
	echo "Site return " $CODE
	ERR=1
	fi
